import logging
from pymongo import UpdateOne

from shared_libs import monogo_connections

from . import cve_lookup


def update_vulnerability(results):

    try:
        db = monogo_connections.connect_monogo()
        try:
            operations = []
            for i in results:
                vul = cve_lookup.get_vul(i["service_type"])
                if vul:
                    logging.info(f"Updating vuls, result is: {vul}")
                    logging.info(f"getting vuls of : {i}")

                operations.append(
                    UpdateOne(
                        {"_id": i["_id"]},
                        {
                            "$set": {"vulnerability": vul}

                        },
                        upsert=True,
                    )
                )
            if operations:
                result = db.scan_results.bulk_write(operations, ordered=False)
                logging.info(
                    f"Flushed {operations}\n updates in one batch to db")

        except Exception as e:
            logging.error(f"Operation do not complete in vuls : {e}")

    except Exception as e:
        logging.error(f"Operation do not complete in vuls : {e}")
